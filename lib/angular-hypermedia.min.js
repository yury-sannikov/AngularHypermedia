/*!
 * angular-hypermedia 0.0.1-20140418
 * http://github.nreca.org/yxs0/angular-hypermedia
 */
"use strict";angular.module("angularHypermedia",[]).provider("Hypermedia",function(){function a(a){angular.extend(c,a)}function b(){return c}var c={apiRoot:null,currentVersion:null,hypermediaFormat:"Siren"},d={};this.setUp=a,this.getConfig=b,this.$get=["$q","$http",c.hypermediaFormat,function(e,f,g){var h=function(){var a=e.defer();return angular.isObject(c.apiRoot)&&(d.data=g.transform(c.apiRoot,c.currentVersion)),d.data?(a.resolve(d.data),a.promise):(f({method:"GET",url:c.apiRoot,headers:{accept:"application/vnd.siren+json"}}).success(function(b){d.data=g.transform(b,c.currentVersion,c.apiRoot),a.resolve(d.data)}).error(function(b,c,d,e){a.reject({data:b,status:c,headers:d,config:e})}),a.promise)};return{setUp:a,getConfig:b,getLink:function(a,b){var c=e.defer();return h().then(function(d){d.link(a,b).then(function(a){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a)}),c.promise}}}]}),angular.module("angularHypermedia").service("Mediamapper",["$q","$http",function(){function a(a,b){var d={};return d.properties=c(angular.copy(a)),d.actions=[],d.links=[],d.actions.push({name:"post",title:"POST action",method:"POST",href:b}),d.actions.push({name:"put",title:"PUT action",method:"PUT",href:b}),d.actions.push({name:"path",title:"PATCH action",method:"PATCH",href:b}),d.actions.push({name:"delete",title:"DELETE action",method:"DELETE",href:b}),d}function b(a){return a=angular.copy(a),a.properties=c(a.properties),a}function c(a){if(!a)return a;var b=function(a,b){a in b&&(b["_"+a]=b[a],delete b[a])};return b("link",a),b("links",a),b("action",a),b("actions",a),a}var d=[{accept:function(a){return angular.isString(a)?-1!=a.indexOf("application/vnd.siren+json"):!1},mapper:b},{accept:function(a){return angular.isString(a)?-1!=a.indexOf("application/json"):!1},mapper:a}];return{get:function(a){if("function"!=typeof a)return null;var b=a("content-type");if(!b)throw"Unknown content-type header value";for(var c in d){var e=d[c];if(e.accept(b))return e.mapper}return angular.noop}}}]),angular.module("angularHypermedia").service("Siren",["$q","$http","Mediamapper",function(a,b,c){function d(a,b,c){if(0==b.indexOf("/")||0==b.indexOf("http"))return b;c=c?"ver:"+c:"latest-version";var d=function(a){var d,e;for(d=0;d<a.length;d++)if(e=a[d],-1!=e.rel.indexOf(b)){if(1==e.rel.length)return e;if(-1!=e.rel.indexOf(c))return e}}(a);return d?d.href:void 0}function e(c,d,e,f){var g=function(c){var d=a.defer();return c.properties?(d.resolve(e(c,f,"",function(){return j.headers.accept})),d.promise):(b({method:"GET",url:c.href,headers:j.headers}).success(function(a,b,g){d.resolve(e(a,f,c.href,g))}).error(function(a,b,c,e){d.reject({data:a,status:b,headers:c,config:e})}),d.promise)},h=function(a,b,c){var d,e;Object.defineProperty(a,b,{get:function(){return e||(e=!0,d=c()),d},enumerable:!0,configurable:!0})};angular.forEach(c,function(a){angular.forEach(a.rel,function(b){h(d,b,function(){return g(a)})})})}function f(a,b){if(!angular.isArray(a))return void 0;var c;for(c=0;c<a.length;c++)if(a[c].name==b)return a[c];return void 0}function g(a,b){if(!a)throw"Invalid parameter 'action'";if(!a.fields||angular.isArray(a.fields)&&0==a.fields.length)return void 0;if(!b)return"Data should be supplied";var c;for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if("undefined"==typeof b[d])return"Supplied data doesn't contain field '"+d+"'"}for(var e in b){for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if(e===d){e=null;break}}if(e)return"Supplied data contains extra field '"+e+"'"}return void 0}function h(a,b){if(!a)return a;var c=a.match(/=:[^&]+/g);if(!c)return a;var d;for(d=0;d<c.length;d++){var e=c[d].replace("=",""),f=e.slice(1);if("undefined"==typeof b[f])throw"Unable to substitute query parameter: unknow variable '"+f+"'";var g=encodeURIComponent(b[f]);a=a.replace(new RegExp(e,"g"),g)}return a}function i(a){var b="An error occurred",c=angular.isNumber(a)?a:500;return angular.isString(a)?b=a:angular.isObject(a)&&(b=a.message||b,c=a.status||c),{data:{Message:b},status:c,headers:angular.noop,config:{}}}var j={headers:{accept:"application/vnd.siren+json"}};return{GetLinkUrlByRelVersion:d,CreateEntities:e,GetActionByName:f,ValidateActionData:g,SubstituteQueryParameters:h,SimulateHTTPErrorFromException:i,transform:function k(l,m,n,o){var p=function(c,l){angular.extend(this,c.properties),e(c.entities,this,k,l),this.link=function(e,f){var g=a.defer();try{var h=f||l,m=d(c.links,e,h);if(!m)throw{status:404,message:"Rel "+e+"/"+h+" not found."};b({method:"GET",url:m,headers:j.headers}).success(function(a,b,c){g.resolve(k(a,l,m,c))}).error(function(a,b,c,d){g.reject({data:a,status:b,headers:c,config:d})})}catch(n){g.reject(i(n))}return g.promise},this.links=function(){return c.links||[]},this.actions=function(){return c.actions||[]},this.action=function(d,e){var m=a.defer();try{var n=f(c.actions,d);if(!n)throw{status:403,message:"Action '"+d+"' forbidden."};var o=g(n,e);if(o)throw{status:400,message:"Bad request '"+d+"'. Message: "+o};var p=(n.method||"GET").toUpperCase(),q={method:p,url:n.href,headers:j.headers};"GET"===p?q.url=h(q.url,e):q.data=e,"function"==typeof e.__urlTransformer&&(q.url=e.__urlTransformer(q.url,e,n)),b(q).success(function(a,b,c){m.resolve(k(a,l,q.url,c))}).error(function(a,b,c,d){m.reject({data:a,status:b,headers:c,config:d})})}catch(r){m.reject(i(r))}return m.promise}},q=c.get(o)||angular.identity;if(!angular.isArray(l))return new p(q(l,n),m,n);var r=[];for(var s in l)r.push(new p(q(l[s],n),m,n));return r}}}]);