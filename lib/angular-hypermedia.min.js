/*!
 * angular-hypermedia 0.0.1-20140423
 * http://github.nreca.org/yxs0/angular-hypermedia
 */
"use strict";angular.module("angularHypermedia",[]).provider("Hypermedia",function(){function a(a){angular.extend(c,a)}function b(){return c}var c={apiRoot:null,currentVersion:null,hypermediaFormat:"Siren"},d={};this.setUp=a,this.getConfig=b,this.$get=["$q","$http",c.hypermediaFormat,"Mediamapper",function(e,f,g,h){var i=function(){var a=e.defer();return angular.isObject(c.apiRoot)&&(d.data=g.transform(c.apiRoot,c.currentVersion)),d.data?(a.resolve(d.data),a.promise):(f({method:"GET",url:c.apiRoot,headers:{accept:"application/vnd.siren+json,application/problem+json,application/json"}}).success(function(b){d.data=g.transform(b,c.currentVersion,c.apiRoot),a.resolve(d.data)}).error(function(b,c,d,e){a.reject(h.problemJson(b,c,d,e))}),a.promise)};return{setUp:a,getConfig:b,getLink:function(a,b){var c=e.defer();return i().then(function(d){d.link(a,b).then(function(a){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a)}),c.promise}}}]}),angular.module("angularHypermedia").service("Mediamapper",["$q","$http",function(){function a(a,b){var d={};return d.properties=c(angular.copy(a)),d.actions=[],d.links=[],d.actions.push({name:"post",title:"POST action",method:"POST",href:b}),d.actions.push({name:"put",title:"PUT action",method:"PUT",href:b}),d.actions.push({name:"path",title:"PATCH action",method:"PATCH",href:b}),d.actions.push({name:"delete",title:"DELETE action",method:"DELETE",href:b}),d}function b(a){return a=angular.copy(a),a.properties=c(a.properties),a}function c(a){if(!a)return a;var b=function(a,b){a in b&&(b["_"+a]=b[a],delete b[a])};return b("link",a),b("links",a),b("action",a),b("actions",a),a}var d=[{accept:function(a){return angular.isString(a)?-1!=a.indexOf("application/vnd.siren+json"):!1},mapper:b},{accept:function(a){return angular.isString(a)?-1!=a.indexOf("application/json"):!1},mapper:a}],e=function(a){var b={type:"about:blank",status:angular.isNumber(a)?a:500};return angular.isString(a)?b.title=a:angular.isObject(a)&&angular.extend(b,a),b};return{get:function(a){if("function"!=typeof a)return null;var b=a("content-type");if(!b)throw"Unknown content-type header value";for(var c in d){var e=d[c];if(e.accept(b))return e.mapper}return angular.noop},problemJsonFromObject:e,problemJson:function(a,b){var c=e(a);return b&&(c.status=b),c}}}]),angular.module("angularHypermedia").service("Siren",["$q","$http","Mediamapper",function(a,b,c){function d(a,b,c){if(0==b.indexOf("/")||0==b.indexOf("http"))return b;c=c?"ver:"+c:"latest-version";var d=function(a){var d,e;for(d=0;d<a.length;d++)if(e=a[d],-1!=e.rel.indexOf(b)){if(1==e.rel.length)return e;if(-1!=e.rel.indexOf(c))return e}}(a);return d?d.href:void 0}function e(d,e,f,g){var h=function(d){var e=a.defer();return d.properties?(e.resolve(f(d,g,"",function(){return i.headers.accept})),e.promise):(b({method:"GET",url:d.href,headers:i.headers}).success(function(a,b,c){e.resolve(f(a,g,d.href,c))}).error(function(a,b,d,f){e.reject(c.problemJson(a,b,d,f))}),e.promise)},j=function(a,b,c){var d,e;Object.defineProperty(a,b,{get:function(){return e||(e=!0,d=c()),d},enumerable:!0,configurable:!0})};angular.forEach(d,function(a){angular.forEach(a.rel,function(b){j(e,b,function(){return h(a)})})})}function f(a,b){if(!angular.isArray(a))return void 0;var c;for(c=0;c<a.length;c++)if(a[c].name==b)return a[c];return void 0}function g(a,b){if(!a)throw"Invalid parameter 'action'";if(!a.fields||angular.isArray(a.fields)&&0==a.fields.length)return void 0;if(!b)return"Data should be supplied";var c;for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if("undefined"==typeof b[d])return"Supplied data doesn't contain field '"+d+"'"}for(var e in b){for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if(e===d){e=null;break}}if(e)return"Supplied data contains extra field '"+e+"'"}return void 0}function h(a,b){if(!a)return a;var c=a.match(/=:[^&]+/g);if(!c)return a;var d;for(d=0;d<c.length;d++){var e=c[d].replace("=",""),f=e.slice(1);if("undefined"==typeof b[f])throw"Unable to substitute query parameter: unknow variable '"+f+"'";var g=encodeURIComponent(b[f]);a=a.replace(new RegExp(e,"g"),g)}return a}var i={headers:{accept:"application/vnd.siren+json,application/problem+json,application/json"}};return{GetLinkUrlByRelVersion:d,CreateEntities:e,GetActionByName:f,ValidateActionData:g,SubstituteQueryParameters:h,transform:function j(k,l,m,n){var o=function(k,l){angular.extend(this,k.properties),e(k.entities,this,j,l),this.link=function(e,f){var g=a.defer();try{var h=f||l,m=d(k.links,e,h);if(!m)throw c.problemJsonFromObject({title:"Not Found",status:404,detail:"Rel "+e+"/"+h+" not found."});b({method:"GET",url:m,headers:i.headers}).success(function(a,b,c){g.resolve(j(a,l,m,c))}).error(function(a,b,d,e){g.reject(c.problemJson(a,b,d,e))})}catch(n){g.reject(c.problemJsonFromObject(n))}return g.promise},this.links=function(){return k.links||[]},this.actions=function(){return k.actions||[]},this.action=function(d,e){var m=a.defer();try{var n=f(k.actions,d);if(!n)throw c.problemJsonFromObject({title:"Forbidden",status:403,detail:"Action '"+d+"' forbidden."});var o=g(n,e);if(o)throw c.problemJsonFromObject({title:"Bad Request",status:400,detail:"Bad request '"+d+"'. Message: "+o});var p=(n.method||"GET").toUpperCase(),q={method:p,url:n.href,headers:i.headers};"GET"===p?q.url=h(q.url,e):q.data=e,"function"==typeof e.__urlTransformer&&(q.url=e.__urlTransformer(q.url,e,n)),b(q).success(function(a,b,c){m.resolve(j(a,l,q.url,c))}).error(function(a,b,d,e){m.reject(c.problemJson(a,b,d,e))})}catch(r){m.reject(c.problemJsonFromObject(r))}return m.promise}},p=c.get(n)||angular.identity;if(!angular.isArray(k))return new o(p(k,m),l,m);var q=[];for(var r in k)q.push(new o(p(k[r],m),l,m));return q}}}]);