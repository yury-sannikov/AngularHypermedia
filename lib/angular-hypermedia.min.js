/*!
 * angular-hypermedia 0.0.1-20140415
 * http://github.nreca.org/yxs0/angular-hypermedia
 */
"use strict";angular.module("angularHypermedia",[]).provider("Hypermedia",function(){function a(a){angular.extend(c,a)}function b(){return c}var c={apiRoot:null,currentVersion:null,hypermediaFormat:"Siren"},d={};this.setUp=a,this.getConfig=b,this.$get=["$q","$http",c.hypermediaFormat,function(e,f,g){var h=function(){var a=e.defer();return angular.isObject(c.apiRoot)&&(d.data=g.transform(c.apiRoot,c.currentVersion)),d.data?(a.resolve(d.data),a.promise):(f({method:"GET",url:c.apiRoot,headers:{accept:"application/vnd.siren+json"}}).success(function(b){d.data=g.transform(b,c.currentVersion),a.resolve(d.data)}).error(function(b){a.reject(b)}),a.promise)};return{setUp:a,getConfig:b,getLink:function(a,b){var c=e.defer();return h().then(function(d){d.link(a,b).then(function(a){c.resolve(a)},function(a){console.log(a),c.reject(a)})},function(a){console.log(a),c.reject(a)}),c.promise}}}]}),angular.module("angularHypermedia").service("Siren",["$q","$http",function(a,b){function c(a,b,c){if(0==b.indexOf("/")||0==b.indexOf("http"))return b;c=c?"ver:"+c:"latest-version";var d=function(a){var d,e;for(d=0;d<a.length;d++)if(e=a[d],-1!=e.rel.indexOf(b)){if(1==e.rel.length)return e;if(-1!=e.rel.indexOf(c))return e}}(a);return d?d.href:void 0}function d(c,d,e,f){var g=function(c){var d=a.defer();return c.properties?(d.resolve(e(c,f)),d.promise):(b({method:"GET",url:c.href,headers:h.headers}).success(function(a){d.resolve(e(a,f))}).error(function(a){d.reject(a)}),d.promise)},i=function(a,b,c){var d,e;Object.defineProperty(a,b,{get:function(){return e||(e=!0,d=c()),d},enumerable:!0,configurable:!0})};angular.forEach(c,function(a){angular.forEach(a.rel,function(b){i(d,b,function(){return g(a)})})})}function e(a,b){var c;for(c=0;c<a.length;c++)if(a[c].name==b)return a[c];return void 0}function f(a,b){if(!b)return void 0;if(!a)throw"Invalid parameter 'action'";if(!a.fields||angular.isArray(a.fields)&&0==a.fields.length)return void 0;var c;for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if("undefined"==typeof b[d])return"Action validation error: Supplied data doesn't contain field '"+d+"'"}for(var e in b){for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if(e===d){e=null;break}}if(e)return"Action validation error: Supplied data contains extra field '"+e+"'"}return void 0}function g(a,b){if(!a)return a;var c=a.match(/=:[^&]+/g);if(!c)return a;var d;for(d=0;d<c.length;d++){var e=c[d].replace("=",""),f=e.slice(1);if("undefined"==typeof b[f])throw"Unable to substitute query parameter: unknow variable '"+f+"'";var g=encodeURIComponent(b[f]);a=a.replace(new RegExp(e,"g"),g)}return a}var h={headers:{accept:"application/vnd.siren+json"}};return{GetLinkUrlByRelVersion:c,CreateEntities:d,GetActionByName:e,ValidateActionData:f,SubstituteQueryParameters:g,transform:function i(j,k){var l=function(j,k){this.link=function(d,e){var f=c(j.links,d,e||k);if(!f)throw"Siren provider is unable to get link for rel "+d+" with version "+e;var g=a.defer();return b({method:"GET",url:f,headers:h.headers}).success(function(a){g.resolve(i(a,k))}).error(function(a){g.reject(a)}),g.promise},this.links=function(){return j.links||[]},this.actions=function(){return j.actions||[]},this.action=function(c,d){var l=e(j.actions,c);if(!l)throw"Siren provider is unable to get action with name "+c;var m=f(l,d);if(m)throw"Action "+c+" has the following data errors: "+m;var n=(l.method||"GET").toUpperCase(),o={method:n,url:l.href,headers:h.headers};"GET"===n?o.url=g(o.url,d):o.data=d;var p=a.defer();return b(o).success(function(a){p.resolve(i(a,k))}).error(function(a){p.reject(a)}),p.promise};var l=angular.isObject(j.properties)||angular.isArray(j.links)||angular.isArray(j.actions);l?(angular.extend(this,j.properties),d(j.entities,this,i,k)):angular.extend(this,j)};if(!angular.isArray(j))return new l(j,k);var m=[];for(var n in j)m.push(new l(j[n],k));return m}}}]);