/*!
 * angular-hypermedia 0.0.1-20140416
 * http://github.nreca.org/yxs0/angular-hypermedia
 */
"use strict";angular.module("angularHypermedia",[]).provider("Hypermedia",function(){function a(a){angular.extend(c,a)}function b(){return c}var c={apiRoot:null,currentVersion:null,hypermediaFormat:"Siren"},d={};this.setUp=a,this.getConfig=b,this.$get=["$q","$http",c.hypermediaFormat,function(e,f,g){var h=function(){var a=e.defer();return angular.isObject(c.apiRoot)&&(d.data=g.transform(c.apiRoot,c.currentVersion)),d.data?(a.resolve(d.data),a.promise):(f({method:"GET",url:c.apiRoot,headers:{accept:"application/vnd.siren+json"}}).success(function(b){d.data=g.transform(b,c.currentVersion),a.resolve(d.data)}).error(function(b,c,d,e){a.reject({data:b,status:c,headers:d,config:e})}),a.promise)};return{setUp:a,getConfig:b,getLink:function(a,b){var c=e.defer();return h().then(function(d){d.link(a,b).then(function(a){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a)}),c.promise}}}]}),angular.module("angularHypermedia").service("Siren",["$q","$http",function(a,b){function c(a,b,c){if(0==b.indexOf("/")||0==b.indexOf("http"))return b;c=c?"ver:"+c:"latest-version";var d=function(a){var d,e;for(d=0;d<a.length;d++)if(e=a[d],-1!=e.rel.indexOf(b)){if(1==e.rel.length)return e;if(-1!=e.rel.indexOf(c))return e}}(a);return d?d.href:void 0}function d(c,d,e,f){var g=function(c){var d=a.defer();return c.properties?(d.resolve(e(c,f)),d.promise):(b({method:"GET",url:c.href,headers:i.headers}).success(function(a){d.resolve(e(a,f))}).error(function(a,b,c,e){d.reject({data:a,status:b,headers:c,config:e})}),d.promise)},h=function(a,b,c){var d,e;Object.defineProperty(a,b,{get:function(){return e||(e=!0,d=c()),d},enumerable:!0,configurable:!0})};angular.forEach(c,function(a){angular.forEach(a.rel,function(b){h(d,b,function(){return g(a)})})})}function e(a,b){if(!angular.isArray(a))return void 0;var c;for(c=0;c<a.length;c++)if(a[c].name==b)return a[c];return void 0}function f(a,b){if(!a)throw"Invalid parameter 'action'";if(!a.fields||angular.isArray(a.fields)&&0==a.fields.length)return void 0;if(!b)return"Data should be supplied";var c;for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if("undefined"==typeof b[d])return"Supplied data doesn't contain field '"+d+"'"}for(var e in b){for(c=0;c<a.fields.length;c++){var d=a.fields[c].name;if(e===d){e=null;break}}if(e)return"Supplied data contains extra field '"+e+"'"}return void 0}function g(a,b){if(!a)return a;var c=a.match(/=:[^&]+/g);if(!c)return a;var d;for(d=0;d<c.length;d++){var e=c[d].replace("=",""),f=e.slice(1);if("undefined"==typeof b[f])throw"Unable to substitute query parameter: unknow variable '"+f+"'";var g=encodeURIComponent(b[f]);a=a.replace(new RegExp(e,"g"),g)}return a}function h(a){var b="An error occurred",c=angular.isNumber(a)?a:500;return angular.isString(a)?b=a:angular.isObject(a)&&(b=a.message||b,c=a.status||c),{data:{Message:b},status:c,headers:angular.noop,config:{}}}var i={headers:{accept:"application/vnd.siren+json"}};return{GetLinkUrlByRelVersion:c,CreateEntities:d,GetActionByName:e,ValidateActionData:f,SubstituteQueryParameters:g,SimulateHTTPErrorFromException:h,transform:function j(k,l){var m=function(k,l){this.link=function(d,e){var f=a.defer();try{var g=e||l,m=c(k.links,d,g);if(!m)throw{status:404,message:"Rel "+d+"/"+g+" not found."};b({method:"GET",url:m,headers:i.headers}).success(function(a){f.resolve(j(a,l))}).error(function(a,b,c,d){f.reject({data:a,status:b,headers:c,config:d})})}catch(n){f.reject(h(n))}return f.promise},this.links=function(){return k.links||[]},this.actions=function(){return k.actions||[]},this.action=function(c,d){var m=a.defer();try{var n=e(k.actions,c);if(!n)throw{status:403,message:"Action '"+c+"' forbidden."};var o=f(n,d);if(o)throw{status:400,message:"Bad request '"+c+"'. Message: "+o};var p=(n.method||"GET").toUpperCase(),q={method:p,url:n.href,headers:i.headers};"GET"===p?q.url=g(q.url,d):q.data=d,b(q).success(function(a){m.resolve(j(a,l))}).error(function(a,b,c,d){m.reject({data:a,status:b,headers:c,config:d})})}catch(r){m.reject(h(r))}return m.promise};var m=angular.isObject(k.properties)||angular.isArray(k.links)||angular.isArray(k.actions);m?(angular.extend(this,k.properties),d(k.entities,this,j,l)):angular.extend(this,k)};if(!angular.isArray(k))return new m(k,l);var n=[];for(var o in k)n.push(new m(k[o],l));return n}}}]);